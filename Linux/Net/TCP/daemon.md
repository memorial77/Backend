# 守护进程创建步骤详解

创建守护进程需要遵循一系列步骤，以确保进程在后台正确运行，不受终端会话的影响。以下是创建守护进程的详细步骤：

## 1. 创建子进程并结束父进程

- 使用`fork()`创建一个子进程。
- 父进程调用`exit()`结束自己，留下子进程继续运行。
- 这一步骤确保新的进程不是一个进程组的领头进程，为创建新会话做准备。

## 2. 创建新会话

- 子进程调用`setsid()`创建一个新的会话，并成为该会话的首进程。
- 这一步使得进程成为新的会话领头，与原有的控制终端断开连接，确保进程不会重新获得控制终端。

## 3. 再次创建子进程并结束首进程

- 再次使用`fork()`创建子进程，然后首进程立即退出。
- 这一步是为了确保新的进程不会成为会话的首进程，因为会话的首进程有可能获得新的控制终端。
- 这样做进一步确保守护进程在后台独立运行。

## 4. 更改文件权限掩码

- 调用`umask(0)`更改文件权限掩码。
- 这一步骤是为了确保守护进程创建的文件具有足够的权限，不受创建时默认权限掩码的限制。

## 5. 更改工作目录

- 使用`chdir("/")`将当前工作目录更改为根目录。
- 这一步骤是为了避免守护进程阻止卸载文件系统，因为如果守护进程的工作目录位于某个挂载点上，那么该挂载点就不能被卸载。

## 6. 关闭所有打开的文件描述符

- 遍历并关闭所有可能打开的文件描述符。
- 这一步骤是因为守护进程通常不需要与终端交互，关闭这些文件描述符可以避免资源泄露，并确保守护进程不会无意中使用到这些文件描述符。

## 7. 重定向标准输入、输出和错误输出

- 将标准输入、输出和错误输出重定向到`/dev/null`。
- 这样做是因为守护进程不应与用户直接交互，重定向这些文件描述符可以防止守护进程尝试读取标准输入或向标准输出和错误输出写入数据。


# 解释 `signal(SIGPIPE, SIG_IGN);`

`signal()` 函数用于修改进程对特定信号的处理方式。它接受两个参数：

- 第一个参数是信号的编号。
- 第二个参数是一个函数指针，指向信号处理函数，或者是特殊值如`SIG_IGN`（忽略信号）或`SIG_DFL`（恢复信号的默认处理）。

## SIGPIPE 信号

`SIGPIPE` 是一个信号，当进程向一个已经关闭的管道或者socket写数据时，会收到这个信号。默认情况下，当进程收到`SIGPIPE`信号时，进程会终止。这在很多网络应用或管道操作中并不是期望的行为，因为写操作失败通常不应该导致进程退出。

## SIG_IGN

`SIG_IGN` 是一个特殊的信号处理方式，表示忽略该信号。当将`SIGPIPE`的处理方式设置为`SIG_IGN`时，如果进程试图写入一个已经关闭的管道或socket，不会收到`SIGPIPE`信号，写操作会失败并返回错误码，进程不会被终止。

## 目的

使用 `signal(SIGPIPE, SIG_IGN);` 的目的是告诉操作系统，如果发生了试图向已关闭的管道或socket写数据的情况，不要发送`SIGPIPE`信号来终止进程，而是让进程能够检测到写操作失败并根据需要处理该错误。

